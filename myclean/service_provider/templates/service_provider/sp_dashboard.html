<!-- This Django syntax allows us to extend this home.html 
 from the static/templates/base.html for a robust front-end. -->

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet" />

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>


 {% extends "base.html" %}

<!-- 'block title' allows us to dynamically define our website title. -->
{% block title %}
    Service Provider Dashboard
{% endblock %}

<!-- 'block content' allows us to inject this html into our base.html -->
{% block content %}

<div class="sp-dashboard-container">
    <h1>Hello {{ user.username }}!</h1>

    <div class="sp-profile-container">
        <h2>Profile</h2>
        <p>Name: {{ service_provider.name }}</p>
        <p>Email: {{ service_provider.email }}</p>
        <p>Contact: {{ service_provider.contact_number }}</p>
        <p>Address: {{ service_provider.address }}</p>
        <p>City: {{ service_provider.city }}</p>
        <p>State: {{ service_provider.state }}</p>
        <p>Post code: {{ service_provider.post_code }}</p>
        <p>Service description: 
            {% if service_provider.description %}
                {{ service_provider.description }}
            {% else %}
                No description provided
            {% endif %}
    </div>

    <div class="calendar-container">
        <h2>Your Schedule</h2>
        <a href="{% url 'sp_add_schedule' %}">
            <button id="add-event-btn">Add Schedule Item</button></a>
        <div id="calendar"></div>  <!-- This is where the FullCalendar will be rendered -->
    </div>
    

    <div class="sp-dashboard-links">
        <a href="{% url 'sp_update_profile' %}">Update</a>
    </div>
    
</div>

<script>
    // When the calendar is rendered
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth', // Default view is month grid
        events: "{% url 'sp_get_schedule' %}",  // Dynamically fetch events URL
        selectable: true, // Allow the user to select a date range
        editable: true, // Allow users to click and drag events
        eventClick: function(info) {
            // When an event is clicked, confirm and redirect to edit the event
            if (confirm("Do you want to edit this event?")) {
                // Dynamically generate the edit URL
                var editUrl = "{% url 'sp_edit_schedule' 0 %}".replace('0', info.event.id);
                window.location.href = editUrl;  // Redirect to the edit page
            }
        },
        select: function(info) {
            // When a date range is selected, generate the add event URL
            var startDate = info.startStr;
            var endDate = info.endStr;
            var addUrl = "{% url 'sp_add_schedule' %}?start=" + startDate + "&end=" + endDate;
            window.location.href = addUrl; // Redirect to the add event page
        },
        // This ensures the calendar fetches new events after an update
        eventSources: [
            {
                url: "{% url 'sp_get_schedule' %}",  // Dynamically fetch events URL
                    method: 'GET',
                    failure: function() {
                        alert('There was an error fetching events.');
                    }
            }
        ]
    });

    // Render the calendar
    calendar.render();
});

</script>
{% endblock %}